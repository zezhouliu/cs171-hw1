<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CS171 Homework 1</title>

  <style type="text/css">
  /* YOUR CSS */
  body * {
    line-height: 1.22em;
  }

  .main-content th, .main-content td {
    padding: 3px;
    border-spacing: 0px;
    border-color: gray;
    border: 1px;
  }

  td, th {
      border-spacing: 0px;
      border-color: gray;
      border: 1px;
  }

  #caption {
    width: 100%;
    height: 100%;
  }

  .ascending {
    cursor: n-resize;
  }

  .descending {
    cursor: s-resize;
  }

  </style>
</head>
<body>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script>

    d3.text("unemp_states_us_nov_2013.tsv", function(error, data){
    
      var parsedData = d3.tsv.parseRows(data);
      var headerData = parsedData.shift();
          
      var zebraFunction = function(d, i) {
          // console.log("Call zebra d:" + d + " i: " + i);
          if (i % 2 === 1) 
            return "#FFFFFF";
          else
            return "#C0C0C0"; 
      };

      var sortColumn = function (header, index) {
        
        if (index < 1) {
          return;
        }

        // Add a static property as a counter to track
        // the number of times the sorting filter is clicked
        if (!header.staticCounter) {
            header.staticCounter = 0;
        }

        header.staticCounter++;
        
        tbody.selectAll("tr").sort(function(a, b) {

          // if odd # of times clicked, sort by increasing order
          if (header.staticCounter % 2 == 1) {

            // if equal priority, sort by name
            if (d3.ascending(a[index], b[index]) == 0) {
              return d3.ascending(a[1], b[1]);
            }

            return d3.ascending(a[index], b[index]);
          }
          else {
              
            // if equal priority, sort by name
            if (d3.descending(a[index], b[index]) == 0) {
              return d3.descending(a[1], b[1]);
            }

            return d3.descending(a[index], b[index]);

          }
        })
          
        .style("background-color", zebraFunction);
        
      };


      // Add the h1 to top of page
      var header1 = d3.select("body").append("h1")
      .text("Unemployment Rates for States"); 

      // add the table
      var table = d3.select("body").append("table")
      .attr("class", "main-content"),
      thead = table.append("thead");
      tbody = table.append("tbody");
      
      // Add stuff to the thead 
      thead.append("tr")
      .append("caption")
      .attr("id", "caption")
      .attr("colspan", "3")
      .html("Unemployment Rates for States Monthly Rankings Seasonally Adjusted");

      // Add the column headers
      var head = thead.selectAll("th")
      .data(headerData)
      .enter()
      .append("th")
      .text(function(d) { return d;})
      .on("click", function (d, i) {
        sortColumn(this, i);
      })
      .on("mouseover", function(d, i) {
      
        // Should not allow sorting by rank, which is col 0
        if (i < 1) {
          return;
        }
        
        // Add a static property as a counter to track
        // the number of times the sorting filter is clicked
        if (!this.staticCounter) {
          this.staticCounter = 0;
        }
        
        var th = d3.select(this);

        // if sorted in decreasing order, then show ascending flag
        if (this.staticCounter % 2 == 0) {
          th.attr("class", "descending"); 
        }
        else {
          th.attr("class", "ascending");
        }
        
      });
      
      // Add stuff to the table bodies
      var rows = tbody.selectAll("tr")
      .data(parsedData)
      .enter()
      .append("tr")
      .style("background-color", zebraFunction)
      .on("mouseover", function(d, i) {
        d3.select(this).style("background-color", "#FFFF00");
      })
      .on("mouseout", function(d, i) {
        d3.select(this).style("background-color", zebraFunction(d, this.rowIndex - 1));
      });

      // Add and configure the cells in the table
      var cells = rows.selectAll("td")
      .data(function(row) {
        return d3.range(Object.keys(row).length).map(function(column, i) {
          return row[Object.keys(row)[i]];
          });
        })
      .enter()
      .append("td")
      .text(function(d) { return d; })
      .attr("class", function (d, i) {
        return "col_" + i; // assign class to each column
      })
      .on('mouseover', function(d, i){
        d3.selectAll("td.col_" + i)
          .style('background-color', "#FFFF00");
      })
      .on('mouseout', function(d, i) {
        d3.selectAll("td.col_" + i)
          .style('background-color', function (d, i) {
          
              var min = d3.min(d3.selectAll("tbody td.col_2")[0], function(td) {
                return Math.min(td.innerHTML);
              });
              var max = d3.max(d3.selectAll("tbody td.col_2")[0], function(td) {
                return Math.max(td.innerHTML);
              });
          
              var color = d3.scale.linear()
                .domain([min, max])
                .interpolate(d3.interpolateRgb)
                .range(["green", "silver"]);
                
              return color(d);
          });
      })
      .style("background-color", function (d, i) {

        if (i == 2) {
          var min = d3.min(d3.selectAll("tbody td.col_2")[0], function(td) {
            return Math.min(td.innerHTML);
          });
          var max = d3.max(d3.selectAll("tbody td.col_2")[0], function(td) {
            return Math.max(td.innerHTML);
          });
      
          var color = d3.scale.linear()
            .domain([min, max])
            .interpolate(d3.interpolateRgb)
            .range(["green", "silver"]);
            
          return color(d);
        }
      });
      
      /*var max = d3.max(d3.selectAll("td.col_2")[0], function(td) {
        //return d3.max(td.innerHTML);
      });
      */
      

      var defaultColumn = 2;
      var col = d3.selectAll("thead th")[0][defaultColumn];
      sortColumn(col, defaultColumn);
      
      

    });

  </script>
</body>
</html>
